---
title: "ANOVA — вариант 1 (α = 0.01)"
output: html_document
params:
  alpha: 0.01
---

```{r step1, message=FALSE, warning=FALSE}
options(stringsAsFactors=FALSE)
alpha <- params$alpha
req_pkgs <- c("dplyr","ggplot2","emmeans","multcomp","multcompView","car","gridExtra","grid","stringr")
for (p in req_pkgs) if (!requireNamespace(p, quietly=TRUE)) install.packages(p, repos="https://cloud.r-project.org")
library(dplyr); library(ggplot2); library(emmeans); library(multcomp); library(multcompView); library(car); library(gridExtra); library(grid); library(stringr)

cars <- read.csv("CARS.csv", check.names=FALSE)
names(cars) <- tolower(gsub("[^a-z0-9]+","_",names(cars)))
numify <- function(x) suppressWarnings(as.numeric(gsub("[ ,]","",as.character(x))))
cars$MPG_City <- numify(cars$MPG_City)
cars$MPG_Highway <- numify(cars$MPG_Highway)
cars$Origin <- as.factor(cars$Origin)
cars$Type <- as.factor(cars$Type)
m1 <- aov(MPG_City ~ Origin, data=cars)
anova1 <- anova(m1)
print(anova1)
```

```{r step2, message=FALSE, warning=FALSE}
emm1 <- emmeans(m1, ~ Origin)
cld1 <- cld(emm1, alpha=alpha, adjust="tukey", Letters=letters)
cld1$.group <- gsub(" ", "", cld1$.group)
grp_map <- setNames(cld1$.group, cld1$Origin)
cars$Origin_grp <- factor(grp_map[as.character(cars$Origin)])
m2 <- aov(MPG_City ~ Origin_grp, data=cars)
anova2 <- anova(m2)
print(cld1)
print(anova2)
```

```{r step3, message=FALSE, warning=FALSE}
pairs_df <- as.data.frame(contrast(emm1, method="pairs", adjust="tukey", level=1-alpha))
ggplot(pairs_df, aes(x=contrast, y=estimate)) +
  geom_hline(yintercept=0, linetype=2) +
  geom_point() +
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2) +
  coord_flip() +
  labs(x="Сравнение", y="Разность средних MPG_city", title="Попарные различия (99% ДИ)")
```

```{r step4, message=FALSE, warning=FALSE}
m4 <- aov(MPG_City ~ Origin_grp + type, data=cars)
anova4 <- anova(m4)
anova24 <- anova(m2, m4)
print(anova4)
print(anova24)
```

```{r step5, message=FALSE, warning=FALSE}
m5_int <- aov(mpg_city ~ origin_grp * type, data=dat)
anova5_int <- anova(m5_int)
anova45 <- anova(m4, m5_int)
final_model <- if (!is.na(anova45$`Pr(>F)`[2]) && anova45$`Pr(>F)`[2] < alpha) m5_int else m4
print(anova5_int)
print(anova45)

df_means <- dat %>% group_by(origin_grp, type) %>% summarize(m=mean(mpg_city), .groups="drop")
ggplot(df_means, aes(x=type, y=m, group=origin_grp)) +
  geom_line() + geom_point() +
  labs(x="type", y="Среднее MPG_city", title="График взаимодействия: origin_grp × type")

emm_final <- emmeans(final_model, ~ origin_grp | type)
pairs_final <- as.data.frame(pairs(emm_final, adjust="tukey"))
ggplot(pairs_final, aes(x=contrast, y=estimate)) +
  geom_hline(yintercept=0, linetype=2) +
  geom_point() +
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2) +
  coord_flip() +
  facet_wrap(~ type, scales="free_y") +
  labs(x="Сравнение", y="Разность средних", title="Попарные различия для финальной модели (99% ДИ)")
```

```{r step6, message=FALSE, warning=FALSE}
emm_cells <- emmeans(aov(mpg_city ~ origin * type, data=dat), ~ origin:type)
levs <- as.data.frame(emm_cells)[,c("origin","type")]
w <- rep(0, nrow(levs))
w[which(levs$type=="sedan" & levs$origin %in% c("asia","europe"))] <- 0.5
w[which(levs$type=="truck" & levs$origin=="usa")] <- -1
ct6 <- contrast(emm_cells, list(EA_sedans_vs_US_trucks = w))
glht_res <- multcomp::summary(as.glht(ct6))
print(glht_res)

dat2 <- dat %>% filter((type=="sedan" & origin %in% c("asia","europe")) | (type=="truck" & origin=="usa")) %>%
  mutate(group = factor(ifelse(type=="sedan", "EA_sedans", "US_trucks")))
aov7 <- aov(mpg_city ~ group, data=dat2)
anova7 <- anova(aov7)
print(anova7)
```

```{r step7, message=FALSE, warning=FALSE}
shapiro_res <- shapiro.test(residuals(aov7))
levene_res <- car::leveneTest(mpg_city ~ group, data=dat2)
print(shapiro_res)
print(levene_res)

res_df <- data.frame(res=residuals(aov7), fit=fitted(aov7))
ggplot(res_df, aes(x=fit, y=res)) + geom_hline(yintercept=0, linetype=2) + geom_point() +
  labs(x="Подгонки", y="Остатки", title="Остатки vs Подгонки (п.6)")
qq <- qqnorm(residuals(aov7), plot.it=FALSE)
ggplot(data.frame(x=qq$x, y=qq$y), aes(x=x, y=y)) + geom_point() + geom_abline(slope=1, intercept=0, linetype=2) +
  labs(x="Теоретические квант.", y="Выборочные квант.", title="QQ-plot (п.6)")
```

```{r step8, message=FALSE, warning=FALSE}
kw8 <- kruskal.test(mpg_city ~ group, data=dat2)
print(kw8)
```

```{r step9, message=FALSE, warning=FALSE}
fmt_anova <- function(a, alpha=alpha) {
  d <- as.data.frame(a)
  if (!"Pr(>F)" %in% names(d)) return(d)
  pv <- d[["Pr(>F)"]]
  d$`Pr(>F)` <- ifelse(is.na(pv), NA, ifelse(pv > alpha, paste0(formatC(pv, format="f", digits=4), "!"), formatC(pv, format="f", digits=4)))
  d
}
tab1 <- fmt_anova(anova1); tab2 <- fmt_anova(anova2); tab4 <- fmt_anova(anova4); tab24 <- fmt_anova(anova24); tab5i <- fmt_anova(anova5_int); tab45 <- fmt_anova(anova45); tab7 <- fmt_anova(anova7)
kw_tab <- data.frame(Statistic=as.numeric(kw8$statistic), DF=as.numeric(kw8$parameter), `Pr(>Chi)`=ifelse(kw8$p.value>alpha, paste0(formatC(kw8$p.value, format="f", digits=4), "!"), formatC(kw8$p.value, format="f", digits=4)))

tg <- function(df, title) gridExtra::tableGrob(df, rows=NULL, theme=gridExtra::ttheme_minimal(core=list(fg_params=list(cex=0.8)), colhead=list(fg_params=list(fontface=2))), cols=names(df))
pg_tab <- function(df, title) { grobTree(textGrob(title, x=0, y=1, just=c("left","top"), gp=gpar(fontface=2, cex=1)), grobTree(tg(df, title)), vp=viewport(width=1, height=0.9, y=0)) }

pdf("anova_report.pdf", width=8.27, height=11.69)
grid.newpage(); grid.draw(pg_tab(tab1, "Шаг 1: ANOVA mpg_city ~ origin"))
grid.newpage(); grid.draw(pg_tab(tab2, "Шаг 2: ANOVA mpg_city ~ origin_grp"))
grid.newpage(); grid.draw(pg_tab(tab4, "Шаг 4: ANOVA mpg_city ~ origin_grp + type"))
grid.newpage(); grid.draw(pg_tab(tab24, "Шаг 4: Сравнение моделей (origin_grp vs origin_grp+type)"))
grid.newpage(); grid.draw(pg_tab(tab5i, "Шаг 5: ANOVA mpg_city ~ origin_grp * type"))
grid.newpage(); grid.draw(pg_tab(tab45, "Шаг 5: Тест взаимодействия (без vs с интеракцией)"))
grid.newpage(); grid.draw(pg_tab(tab7, "Шаг 6: \"В лоб\" ANOVA (EA_sedans vs US_trucks)"))
grid.newpage(); grid.draw(pg_tab(kw_tab, "Шаг 8: Краскел-Уоллис (EA_sedans vs US_trucks)"))
dev.off()
```
